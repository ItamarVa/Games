<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ğŸŒŸ ×ª×¨×’×•×œ ××ª××˜×™×§×” ××”× ×” ğŸŒŸ</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grad)' rx='20'/%3E%3Ctext x='50' y='70' font-size='60' font-weight='bold' fill='white' text-anchor='middle' font-family='Arial, sans-serif'%3EÂ±%3C/text%3E%3C/svg%3E" />
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-color: #f8f9ff;
      --text-color: #1e293b;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --fun-blue: #3b82f6;
      --fun-purple: #8b5cf6;
      --fun-pink: #ec4899;
      --fun-green: #10b981;
      --fun-orange: #f97316;
      --fun-yellow: #fbbf24;
    }

    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      font-family: 'Segoe UI', 'Comic Sans MS', Arial, sans-serif;
      text-align: center;
      padding: 0;
      direction: rtl;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      position: relative;
      height: 100vh;
      margin: 0;
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: var(--bg-opacity, 0.15);
      z-index: -1;
      background-image: var(--current-background);
      background-size: cover;
      background-position: center;
      transition: none;
      filter: grayscale(20%);
      will-change: transform;
    }

    .container {
      max-width: 95%;
      width: 800px;
      margin: 5px auto;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
      padding: 15px;
      border-radius: 25px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.5);
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
      backdrop-filter: blur(10px);
      border: 3px solid rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 20px);
      box-sizing: border-box;
    }

    /* Grade Selection Screen */
    .grade-selection {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      padding: 20px;
      position: relative;
    }

    .info-button {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 10;
    }

    .info-button:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
    }

    .info-button:active {
      transform: scale(1.05) rotate(0deg);
    }

    .grade-selection h1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 3em;
      font-weight: 800;
      margin-bottom: 40px;
      text-shadow: none;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .grade-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      width: 100%;
      max-width: 500px;
    }

    .grade-button {
      font-size: 26px;
      font-weight: 700;
      padding: 22px 30px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      position: relative;
      overflow: hidden;
    }

    .grade-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .grade-button:hover::before {
      width: 300px;
      height: 300px;
    }

    .grade-button:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
    }

    .grade-button:active {
      transform: translateY(-2px) scale(1.02);
    }

    /* Game Screen */
    .game-screen {
      display: none;
      position: relative;
      flex: 1;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
      /* Ensure game screen uses available space properly */
      height: 100%;
    }

    /* Mobile game screen adjustments */
    @media (max-width: 600px) {
      .game-screen {
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        /* Use safe area insets for iPhone notch/home indicator */
        padding-bottom: env(safe-area-inset-bottom, 0);
        /* Smooth scrolling */
        -webkit-overflow-scrolling: touch;
        /* Ensure proper height calculation */
        max-height: 100dvh;
      }

      /* Ensure content area scrolls properly when keyboard is visible */
      .game-screen > div[style*="flex: 1"] {
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        /* Ensure content fits above keyboard */
        max-height: calc(100dvh - 200px);
      }

      /* Keep buttons visible at bottom - always above keyboard */
      .button-group {
        position: sticky;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
        padding-top: 5px;
        margin-top: auto;
        z-index: 100;
        /* Add shadow to make it stand out */
        box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
        /* Ensure it stays above keyboard */
        margin-bottom: env(keyboard-inset-height, 0);
      }
      
      /* When keyboard is visible, adjust layout */
      .game-screen.keyboard-visible .button-group {
        position: fixed;
        bottom: env(keyboard-inset-height, 0);
        left: 0;
        right: 0;
        width: 100%;
        padding-left: 5px;
        padding-right: 5px;
        box-sizing: border-box;
      }
      
      .game-screen.keyboard-visible > div[style*="flex: 1"] {
        padding-bottom: 80px; /* Space for buttons */
      }
    }

    .game-screen.active {
      display: flex;
    }

    .grade-indicator {
      position: absolute;
      top: 5px;
      left: 5px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 800;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border: 3px solid rgba(255, 255, 255, 0.5);
      animation: indicatorPulse 2s ease-in-out infinite;
      z-index: 100;
      /* Increase touch target */
      padding: 10px;
      box-sizing: border-box;
    }

    @keyframes indicatorPulse {
      0%, 100% { box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
      50% { box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6); }
    }

    .grade-indicator:hover {
      transform: scale(1.15) rotate(5deg);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
    }

    .report-button {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      border: 3px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      padding: 0;
      line-height: 1;
      opacity: 1;
      z-index: 100;
      /* Increase touch target */
      box-sizing: border-box;
    }

    .report-button:hover {
      transform: scale(1.15) rotate(5deg);
      box-shadow: 0 12px 30px rgba(239, 68, 68, 0.6);
      opacity: 1;
    }

    .header {
      margin-bottom: 10px;
      padding-top: 5px;
      flex-shrink: 0;
    }

    .title {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2em;
      font-weight: 800;
      margin-bottom: 8px;
      text-shadow: none;
      animation: titleGlow 3s ease-in-out infinite;
    }

    @keyframes titleGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2); }
    }

    .exercise {
      font-size: 32px;
      font-weight: 800;
      margin: 8px 0;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      border-radius: 15px;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      direction: ltr;
      unicode-bidi: bidi-override;
      text-align: center;
      color: #1e293b;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2), 0 0 0 2px rgba(102, 126, 234, 0.1);
      border: 3px solid rgba(102, 126, 234, 0.2);
      animation: exerciseFloat 3s ease-in-out infinite;
      flex-shrink: 0;
    }

    @keyframes exerciseFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }

    .fraction {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      margin: 0 5px;
    }

    .fraction-numerator {
      display: block;
      border-bottom: 3px solid currentColor;
      padding: 0 5px;
      line-height: 1.3;
      font-weight: 600;
    }

    .fraction-denominator {
      display: block;
      padding: 0 5px;
      line-height: 1.3;
      font-weight: 600;
    }

    .input-container-wrapper {
      position: relative;
      min-height: 170px;
      height: 170px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 8px 0;
      flex-shrink: 0;
    }

    /* Mobile-specific input container adjustments */
    @media (max-width: 600px) {
      .input-container-wrapper {
        min-height: 50px !important;
        height: auto !important;
        margin: 2px 0 !important;
        padding: 2px 0 !important;
        flex-shrink: 0;
      }
    }

    .fraction-input-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .fraction-input-container.active {
      opacity: 1;
      pointer-events: all;
    }

    input#answer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 1;
      pointer-events: all;
      transition: opacity 0.2s ease;
      font-size: 28px;
      font-weight: 700;
      padding: 12px 20px;
      width: 250px;
      border: 4px solid;
      border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1;
      border-radius: 15px;
      text-align: center;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
      color: #1e293b;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
    }

    input#answer.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .fraction-input-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .fraction-whole-input {
      font-size: 32px;
      font-weight: 700;
      padding: 18px 24px;
      width: 120px;
      border: 4px solid;
      border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1;
      border-radius: 15px;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      -moz-appearance: textfield;
      appearance: textfield;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
      color: #1e293b;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
      /* Ensure input is easily tappable on mobile */
      cursor: text;
      -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
    }

    .fraction-whole-input::-webkit-outer-spin-button,
    .fraction-whole-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .fraction-whole-input:focus {
      outline: none;
      border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1;
      box-shadow: 0 0 25px rgba(102, 126, 234, 0.5), 0 8px 25px rgba(102, 126, 234, 0.3);
      transform: scale(1.05);
      background: #ffffff;
    }

    .fraction-input-wrapper {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
      border: 4px solid;
      border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1;
      border-radius: 15px;
      padding: 15px 20px;
      min-width: 150px;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.25);
      transition: all 0.3s ease;
      /* Make wrapper clickable to focus numerator */
      cursor: pointer;
      -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
    }

    .fraction-input-wrapper:focus-within {
      box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
      transform: scale(1.02);
    }

    .fraction-input-wrapper input {
      border: none;
      outline: none;
      text-align: center;
      font-size: 32px;
      font-weight: 700;
      width: 100px;
      padding: 12px;
      background: transparent;
      -moz-appearance: textfield;
      appearance: textfield;
      color: #1e293b;
      /* Ensure inputs are easily tappable on mobile */
      cursor: text;
      -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
    }

    .fraction-input-wrapper input::-webkit-outer-spin-button,
    .fraction-input-wrapper input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .fraction-input-line {
      width: 100%;
      height: 3px;
      background-color: var(--primary-color);
      margin: 8px 0;
      border-radius: 2px;
    }

    .fraction-input-hint {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-color);
      margin-top: 6px;
      opacity: 0.85;
    }

    .exercise:hover {
      transform: scale(1.02);
    }

    button {
      font-size: 20px;
      font-weight: 600;
      padding: 14px 28px;
      margin: 8px;
      border: none;
      border-radius: 10px;
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin: 8px 0 0 0;
      flex-shrink: 0;
      margin-top: auto;
    }

    .button-group button {
      font-size: 18px;
      padding: 12px 24px;
      margin: 8px;
      border: none;
      border-radius: 8px;
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .button-group button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .feedback {
      font-size: 18px;
      font-weight: 700;
      margin: 8px 0;
      padding: 12px 18px;
      border-radius: 15px;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      animation: feedbackSlide 0.5s ease-out;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      flex-shrink: 0;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    @keyframes feedbackSlide {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .feedback.correct {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
      color: #059669;
      border: 3px solid rgba(16, 185, 129, 0.3);
      animation: correctBounce 0.6s ease-out;
    }

    @keyframes correctBounce {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.1) rotate(2deg); }
      75% { transform: scale(1.05) rotate(-2deg); }
    }

    .feedback.incorrect {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
      color: #dc2626;
      border: 3px solid rgba(239, 68, 68, 0.3);
      animation: incorrectShake 0.5s ease-out;
      flex-direction: column;
      gap: 12px;
    }

    .try-again-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      margin-top: 8px;
    }

    .try-again-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
    }

    .try-again-btn:active {
      transform: translateY(0);
    }

    .reveal-answer-btn {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    .reveal-answer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(245, 158, 11, 0.6);
    }

    .reveal-answer-btn:active {
      transform: translateY(0);
    }

    .continue-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .continue-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.6);
    }

    .continue-btn:active {
      transform: translateY(0);
    }

    @keyframes incorrectShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .stats {
      display: flex;
      justify-content: space-around;
      margin: 8px 0;
      padding: 12px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
      border: 2px solid rgba(102, 126, 234, 0.2);
      backdrop-filter: blur(10px);
      flex-shrink: 0;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 26px;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      animation: statPulse 2s ease-in-out infinite;
    }

    @keyframes statPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .stat-label {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
      margin-top: 3px;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border-radius: 10px;
      margin: 8px 0;
      overflow: hidden;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 2px solid rgba(102, 126, 234, 0.2);
      flex-shrink: 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-size: 200% 100%;
      animation: progressShine 2s linear infinite;
      transition: width 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
      border-radius: 10px;
    }

    @keyframes progressShine {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    .achievement {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 20px;
      animation: achievementPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 1000;
      box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
      font-weight: 700;
      font-size: 18px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    @keyframes achievementPop {
      0% {
        opacity: 0;
        transform: scale(0.5) translateY(-50px) rotate(-10deg);
      }
      50% {
        transform: scale(1.1) translateY(0) rotate(5deg);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0) rotate(0deg);
      }
    }

    /* Tablet Landscape (Horizontal) - Priority fix */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
      .container {
        max-width: 95%;
        width: 95%;
        margin: 3px auto;
        padding: 8px;
        max-height: calc(100vh - 6px);
      }
      
      .game-screen.active {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
      }
      
      .game-screen:not(.active) {
        display: none !important;
      }

      .grade-selection {
        min-height: auto;
        padding: 15px;
        padding-top: 60px; /* Add top padding to prevent text cutoff */
      }

      .grade-selection h1 {
        font-size: 1.8em;
        margin-bottom: 20px;
        margin-top: 10px;
        padding-top: 10px;
        line-height: 1.2;
      }

      .grade-buttons {
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        max-width: 100%;
      }

      .grade-button {
        font-size: 18px;
        padding: 15px 10px;
      }

      .title {
        font-size: 1.5em !important;
        margin: 5px 0;
      }

      .stats {
        padding: 8px;
        margin: 5px 0;
      }

      .stat-value {
        font-size: 22px;
      }

      .stat-label {
        font-size: 12px;
      }

      .exercise {
        font-size: 1.6em !important;
        padding: 10px !important;
        margin: 3px 0 !important;
        line-height: 1.3;
      }

      .input-container-wrapper {
        min-height: 70px !important;
        height: auto !important;
        margin: 2px 0 !important;
        padding: 2px 0 !important;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      input#answer {
        font-size: 20px !important;
        width: 250px;
        padding: 6px;
        height: 45px;
        position: relative !important;
        top: 0 !important;
        left: 0 !important;
        transform: none !important;
        margin: 0 auto !important;
      }

      input#answer.hidden {
        display: none !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }

      .fraction-input-container {
        position: relative !important;
        display: flex !important;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 2px 0;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        margin: 0 !important;
      }

      .fraction-input-container:not(.active) {
        display: none !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }

      .fraction-input-container.active {
        display: flex !important;
        opacity: 1 !important;
        pointer-events: all !important;
      }

      .fraction-input-row {
        flex-direction: row !important;
        gap: 6px !important;
        align-items: center;
        justify-content: center;
        width: 100%;
        flex-wrap: nowrap;
        margin: 0 !important;
        padding: 0 !important;
      }

      .fraction-whole-input {
        font-size: 18px !important;
        width: 60px !important;
        padding: 4px 6px !important;
        height: 38px !important;
        flex-shrink: 0;
        margin: 0 !important;
      }

      .fraction-input-wrapper {
        padding: 4px 8px !important;
        min-width: 75px !important;
        max-width: 75px !important;
        width: 75px !important;
        flex-shrink: 0;
        margin: 0 !important;
      }

      .fraction-input-wrapper input {
        font-size: 18px !important;
        width: 55px !important;
        padding: 3px !important;
        min-height: 28px;
        max-height: 28px;
      }

      .fraction-input-line {
        height: 2px !important;
        margin: 2px 0 !important;
      }

      .fraction-input-hint {
        font-size: 11px !important;
        margin-top: 4px !important;
        text-align: center;
        display: none !important; /* Hide hint on tablet to save space */
      }

      .button-group {
        flex-direction: row;
        gap: 5px !important; /* Reduced gap between buttons */
        margin: 3px 0 !important;
        padding: 2px 0;
      }

      .button-group button {
        flex: 1;
        padding: 8px 10px !important; /* Reduced padding */
        font-size: 15px !important;
        height: auto;
        margin: 0 !important; /* Remove margins */
        min-height: 44px;
      }

      .feedback {
        font-size: 15px;
        padding: 8px;
        margin: 3px 0;
        min-height: auto;
      }

      .progress-bar {
        margin: 3px 0;
        height: 6px;
      }
      
      /* Lock scrolling - ensure exercise and input are always visible */
      .game-screen > div[style*="flex: 1"] {
        max-height: calc(100vh - 140px) !important; /* Reduced to fit exercise + compact input + buttons */
        overflow-y: hidden !important; /* Lock scrolling */
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
      }
      
      /* Make sure exercise and input are both visible - no scrolling */
      .exercise {
        flex-shrink: 0;
        overflow: visible;
        max-height: 50% !important; /* Limit exercise height to ensure input is visible */
      }
      
      .input-container-wrapper {
        flex-shrink: 0;
        overflow: visible;
        min-height: 70px !important;
        height: auto !important;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Hide feedback on tablet to save space */
      .feedback {
        display: none !important;
      }
      
      .header {
        margin-bottom: 3px;
        padding-top: 2px;
      }
      
      .title {
        font-size: 1.4em !important;
        margin: 3px 0 !important;
      }
      
      .stats {
        padding: 5px !important;
        margin: 3px 0 !important;
      }
    }

    /* Tablet Portrait */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
      .container {
        max-width: 90%;
        width: 90%;
        margin: 10px auto;
        padding: 15px;
      }

      .grade-buttons {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .grade-button {
        font-size: 22px;
        padding: 18px 15px;
      }
    }

    @media (max-width: 600px) {
      body {
        height: 100%;
        overflow: hidden;
        position: fixed;
        width: 100%;
        background-color: #ffffff;
        /* Use dynamic viewport height for better keyboard handling */
        height: 100dvh;
      }

      body::before {
        display: none;
      }

      .container {
        margin: 0;
        padding: 5px;
        width: 100%;
        max-width: 100%;
        border-radius: 0;
        /* Use dynamic viewport height - adjusts when keyboard appears */
        min-height: 100dvh;
        max-height: 100dvh;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .title {
        font-size: 1.2em !important;
        margin: 8px 0 3px 0;
        padding: 0;
        line-height: 1.2;
      }

      .header {
        margin-bottom: 4px;
        padding-top: 3px;
      }
      
      .title {
        margin-bottom: 2px !important;
      }

      .stats {
        flex-direction: row;
        flex-wrap: nowrap;
        margin: 3px 0 !important;
        padding: 3px !important;
        gap: 1px;
        background-color: transparent;
      }

      .stat-item {
        flex: 1;
        margin: 0;
        padding: 1px;
      }

      .stat-value {
        font-size: 16px !important;
        line-height: 1.1;
        font-weight: bold;
      }

      .stat-label {
        font-size: 10px !important;
        line-height: 1.1;
        font-weight: 500;
      }

      .exercise {
        font-size: 1.3em !important;
        font-weight: bold !important;
        padding: 8px !important;
        margin: 4px 0 !important;
        transform: none !important;
        background-color: rgba(245, 245, 245, 0.8);
        line-height: 1.3;
      }

      .fraction {
        font-size: 1.2em;
        margin: 0 3px;
      }

      .fraction-numerator,
      .fraction-denominator {
        font-size: 0.9em;
        padding: 0 2px;
      }

      input#answer {
        font-size: 1.4em !important;
        font-weight: 600 !important;
        padding: 12px !important;
        width: 90% !important;
        margin: 10px auto !important;
        display: block;
        -webkit-appearance: none;
        appearance: none;
        height: 50px;
        border-width: 3px !important;
      }

      .grade-selection {
        padding-top: 20px !important; /* Reduced top padding */
        min-height: calc(100vh - 20px);
      }
      
      .grade-selection h1 {
        font-size: 1.6em !important;
        margin-top: 5px !important;
        margin-bottom: 15px !important;
        padding-top: 5px !important;
        line-height: 1.2 !important;
      }

      .grade-buttons {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        max-width: 100%;
        padding: 10px;
        margin-top: 10px;
      }

      .grade-button {
        font-size: 18px;
        padding: 14px 18px;
      }
      
      .info-button {
        top: 60px !important; /* Adjust position to account for notch */
      }

      .button-group {
        flex-direction: column;
        gap: 3px !important;
        margin: 3px 0 !important;
        /* Ensure buttons stay visible above keyboard */
        flex-shrink: 0;
        padding-bottom: env(safe-area-inset-bottom, 3px);
      }

      .button-group button {
        width: 100%;
        margin: 1px 0;
        padding: 8px !important;
        font-size: 14px !important;
        -webkit-appearance: none;
        appearance: none;
        min-height: 40px !important;
        /* Ensure buttons are tappable */
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
      }
      
      .button-group .check-answer-btn {
        min-height: 42px !important;
        font-size: 15px !important;
      }

      .progress-bar {
        margin: 2px 0 !important;
        height: 4px !important;
      }

      .feedback {
        font-size: 14px;
        font-weight: 500;
        margin: 4px 0;
        padding: 6px;
        min-height: auto;
      }
      
      /* Hide feedback in normal flow - will show as popup for all devices */
      .feedback.incorrect {
        display: none !important;
      }

      .try-again-btn,
      .reveal-answer-btn,
      .continue-btn {
        font-size: 14px;
        padding: 8px 16px;
        margin-top: 6px;
      }

      #wrongAnswerActions {
        flex-direction: column;
        gap: 8px;
      }

      .fraction-input-container {
        margin: 2px 0 !important;
        position: relative !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
      }

      /* Keep fraction inputs horizontal on mobile - whole number to the side, make them smaller */
      .fraction-input-row {
        flex-direction: row !important;
        gap: 4px !important;
        align-items: center;
        justify-content: center;
        flex-wrap: nowrap;
        width: 100%;
        max-width: 100%;
        padding: 2px;
        margin: 0 !important;
      }
      
      /* Make fraction inputs smaller and more compact */
      .fraction-input-wrapper {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%) !important;
        border: 2px solid !important;
        border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1 !important;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2) !important;
        padding: 3px 6px !important;
        min-width: 60px !important;
        max-width: 60px !important;
        width: 60px !important;
        flex-shrink: 0;
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
        pointer-events: auto;
        margin: 0 !important;
      }
      
      .fraction-input-wrapper input {
        font-size: 16px !important;
        font-weight: 600 !important;
        width: 45px !important;
        padding: 3px !important;
        min-height: 28px !important;
        max-height: 28px !important;
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
        pointer-events: auto;
      }
      
      .fraction-input-line {
        height: 2px !important;
        margin: 2px 0 !important;
      }

      .fraction-whole-input {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%) !important;
        border: 2px solid !important;
        border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1 !important;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2) !important;
        font-size: 16px !important;
        font-weight: 600 !important;
        width: 50px !important;
        padding: 3px 5px !important;
        border-width: 2px !important;
        flex-shrink: 0;
        min-height: 28px !important;
        max-height: 28px !important;
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
        margin: 0 !important;
      }

      .fraction-input-hint {
        font-size: 11px !important;
        font-weight: 500;
        margin-top: 2px;
        line-height: 1.2;
      }

      .achievement {
        position: fixed;
        top: 5px;
        right: 5px;
        left: 5px;
        padding: 8px 15px;
        font-size: 14px;
        text-align: center;
        margin: 0 auto;
        width: auto;
        max-width: 90%;
        transform: translateY(0);
        animation: slideInMobile 0.5s ease-out;
      }

      @keyframes slideInMobile {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .grade-indicator {
        width: 50px;
        height: 50px;
        font-size: 22px;
        top: 5px;
        left: 5px;
        padding: 8px;
      }

      .report-button {
        width: 50px;
        height: 50px;
        font-size: 20px;
        top: 5px;
        right: 5px;
        padding: 0;
      }

      .info-button {
        width: 45px;
        height: 45px;
        font-size: 20px;
        top: 15px;
        right: 15px;
      }

      .button-group .check-answer-btn,
      .button-group .check-answer-btn:hover,
      .button-group .check-answer-btn:active,
      .button-group .check-answer-btn:focus {
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        box-sizing: border-box;
      }
    }

    /* Add viewport height adjustment for mobile keyboard - when keyboard is visible */
    @media (max-width: 600px) and (max-height: 500px) {
      .container {
        padding: 3px;
        /* Use smaller viewport when keyboard is visible */
        max-height: 100svh;
      }

      .title {
        font-size: 1.1em !important;
        margin: 2px 0;
      }

      .stats {
        margin: 3px 0;
        padding: 3px;
        flex-wrap: wrap;
      }

      .stat-item {
        flex: 1 1 45%;
        min-width: 45%;
      }

      .stat-value {
        font-size: 18px;
      }

      .stat-label {
        font-size: 11px;
      }

      .exercise {
        margin: 3px 0;
        padding: 8px !important;
        font-size: 1.3em !important;
        line-height: 1.3;
      }

      .input-container-wrapper {
        min-height: 100px;
        height: 100px;
        margin: 3px 0;
      }

      .button-group {
        margin: 3px 0;
        gap: 3px;
      }

      .button-group button {
        padding: 8px;
        min-height: 40px;
        font-size: 14px;
      }

      .feedback {
        margin: 3px 0;
        padding: 6px;
        font-size: 14px;
        min-height: auto;
      }

      .try-again-btn,
      .reveal-answer-btn,
      .continue-btn {
        font-size: 12px;
        padding: 6px 12px;
        margin-top: 4px;
      }

      #wrongAnswerActions {
        flex-direction: column;
        gap: 6px;
      }

      input#answer {
        height: 40px;
        margin: 3px auto !important;
        font-size: 1.2em !important;
        padding: 8px !important;
      }

      .fraction-input-row {
        gap: 6px;
      }

      .fraction-whole-input {
        font-size: 20px !important;
        width: 60px !important;
        padding: 8px !important;
      }

      .fraction-input-wrapper {
        padding: 6px 10px;
        min-width: 90px;
      }

      .fraction-input-wrapper input {
        font-size: 20px !important;
        width: 60px;
        padding: 6px;
      }

      .fraction-input-hint {
        font-size: 11px;
        margin-top: 4px;
      }
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Custom button styles for game screen */
    .button-group .check-answer-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
      color: #fff;
      font-weight: 800;
      font-size: 22px;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      border: none;
      outline: none;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
      overflow: hidden;
    }
    .button-group .check-answer-btn::before {
      content: 'âœ¨';
      position: absolute;
      left: -30px;
      transition: left 0.5s;
    }
    .button-group .check-answer-btn:hover::before {
      left: 20px;
    }
    .button-group .check-answer-btn:hover,
    .button-group .check-answer-btn:active,
    .button-group .check-answer-btn:focus {
      transform: translateY(-3px) scale(1.05) !important;
      box-shadow: 0 12px 35px rgba(16, 185, 129, 0.5);
    }
    .button-group .skip-btn,
    .button-group .change-level-btn {
      font-weight: 700;
      font-size: 20px;
    }
    .button-group .skip-btn {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
      color: #fff;
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
    }
    .button-group .skip-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 35px rgba(139, 92, 246, 0.5);
    }
    .button-group .change-level-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    .button-group .change-level-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
    }

    .button-group {
      flex-direction: column;
    }
    .button-group button,
    .button-group .check-answer-btn {
      width: 100%;
      box-sizing: border-box;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Major Level Selection Screen -->
    <div class="grade-selection" id="gradeSelection">
      <button class="info-button" onclick="showInfo()" title="××™×“×¢">â„¹ï¸</button>
      <h1>ğŸŒŸ ×‘×—×¨×• ×¨××” ×¨××©×™×ª ğŸŒŸ</h1>
      <div class="grade-buttons" id="majorLevelButtons">
        <!-- Buttons will be generated dynamically -->
      </div>
    </div>

    <!-- Game Screen -->
    <div class="game-screen" id="gameScreen">
      <div class="grade-indicator" id="gradeIndicator" onclick="returnToMainScreen()" title="×—×–×•×¨ ×œ××¡×š ×”×¨××©×™"></div>
      <button class="report-button" onclick="shareReport()" title="×©×œ×— ×“×•×—">ğŸ“§</button>
      <div class="header">
        <h1 class="title">&#9733; ×ª×¨×’×•×œ ××ª××˜×™×§×” ××”× ×” &#9733;</h1>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="score">0</div>
          <div class="stat-label">× ×™×§×•×“</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="majorLevel">1</div>
          <div class="stat-label">×¨××” ×¨××©×™×ª</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="subLevel">1</div>
          <div class="stat-label">×ª×ª ×¨××”</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="streak">0</div>
          <div class="stat-label">×¨×¦×£ × ×›×•×Ÿ</div>
        </div>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <div style="flex: 1; display: flex; flex-direction: column; min-height: 0; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; max-height: calc(100dvh - 180px);">
        <div class="exercise" id="problem"></div>
        
        <!-- Input container - fixed height to prevent layout shift -->
        <div class="input-container-wrapper">
          <!-- Regular number input -->
          <input type="text" id="answer" inputmode="numeric" placeholder="×”×›× ×¡ ××ª ×”×ª×©×•×‘×” ×©×œ×š">
          
          <!-- Fraction input (shown when fraction problem) -->
          <div id="fractionInput" class="fraction-input-container">
            <div class="fraction-input-row">
              <div class="fraction-input-wrapper">
                <input type="number" id="fractionNumerator" inputmode="numeric" placeholder="××•× ×”" min="0" step="1" tabindex="2">
                <div class="fraction-input-line"></div>
                <input type="number" id="fractionDenominator" inputmode="numeric" placeholder="××›× ×”" min="1" step="1" tabindex="3">
              </div>
              <input type="number" id="fractionWhole" inputmode="numeric" placeholder="×©×œ×" min="0" step="1" class="fraction-whole-input" tabindex="1">
            </div>
            <div class="fraction-input-hint">×”×›× ×¡ ××¡×¤×¨ ×©×œ×, ×©×‘×¨, ××• ××¡×¤×¨ ××¢×•×¨×‘</div>
          </div>
        </div>

        <div id="feedback" class="feedback">
          <span id="feedbackText"></span>
          <div id="wrongAnswerActions" style="display: none; gap: 10px; margin-top: 10px; flex-direction: row; justify-content: center; flex-wrap: wrap;">
            <button id="tryAgainBtn" class="try-again-btn" onclick="retryQuestion()">× ×¡×” ×©×•×‘</button>
            <button id="revealAnswerBtn" class="reveal-answer-btn" onclick="revealAnswer()">×’×œ×” ×ª×©×•×‘×”</button>
          </div>
          <div id="revealedAnswer" style="display: none; margin-top: 10px;">
            <span id="revealedAnswerText" style="font-size: 20px; font-weight: 700;"></span>
            <button id="continueBtn" class="continue-btn" onclick="continueToNext()" style="margin-top: 10px;">×”××©×š</button>
          </div>
        </div>
      </div>
      
      <div class="button-group">
        <button class="check-answer-btn" onclick="checkAnswer()">×‘×“×•×§ ×ª×©×•×‘×”</button>
        <button class="skip-btn" onclick="newProblem()">×©××œ×” ×—×“×©×”</button>
        <button class="change-level-btn" onclick="changeDifficulty()">×©× ×” ×¨××”</button>
      </div>
    </div>
  </div>

  <script>
    const TOTAL_MAJOR_LEVELS = 10;
    const SUB_LEVELS_PER_MAJOR = 10;
    const QUESTIONS_PER_SUB_LEVEL = 5; // Questions needed to advance sub-level
    
    let score = 0;
    let majorLevel = 1;
    let subLevel = 1;
    let questionsInCurrentSubLevel = 0;
    let streak = 0;
    let currentAnswer = null; // Can be number or fraction object
    let isMobile = window.innerWidth <= 600;
    let allQuestions = []; // Track ALL questions: {question, correctAnswer, userAnswer, status: 'correct'|'wrong'|'skipped', timestamp}
    let currentProblem = '';
    let isFractionProblem = false;
    let lastProblemParams = null; // Store parameters to retry the same problem
    let currentQuestionId = null; // Track current question to avoid duplicate tracking on retry

    // Restore state from localStorage if available (unless explicitly reset)
    function loadState() {
      const savedAllQuestions = localStorage.getItem('allQuestions');
      const savedScore = localStorage.getItem('score');
      const savedMajorLevel = localStorage.getItem('majorLevel');
      const savedSubLevel = localStorage.getItem('subLevel');
      const savedQuestionsInCurrentSubLevel = localStorage.getItem('questionsInCurrentSubLevel');
      const savedStreak = localStorage.getItem('streak');
      const savedScreenState = localStorage.getItem('currentScreen'); // 'game' or 'selection'
      
      if (savedAllQuestions) {
        try {
          allQuestions = JSON.parse(savedAllQuestions);
        } catch (e) {
          console.error('Error parsing saved questions:', e);
          allQuestions = [];
        }
      }
      
      if (savedScore !== null) score = parseInt(savedScore) || 0;
      if (savedMajorLevel !== null) majorLevel = parseInt(savedMajorLevel) || 1;
      if (savedSubLevel !== null) subLevel = parseInt(savedSubLevel) || 1;
      if (savedQuestionsInCurrentSubLevel !== null) questionsInCurrentSubLevel = parseInt(savedQuestionsInCurrentSubLevel) || 0;
      if (savedStreak !== null) streak = parseInt(savedStreak) || 0;
      
      // Restore screen state
      if (savedScreenState === 'game' && majorLevel > 0) {
        // Restore game screen
        document.getElementById('gradeSelection').style.display = 'none';
        document.getElementById('gameScreen').classList.add('active');
        document.getElementById('gradeIndicator').textContent = majorLevel;
        updateStats();
        generateProblem();
      } else {
        // Show level selection
        document.getElementById('gradeSelection').style.display = 'flex';
        document.getElementById('gameScreen').classList.remove('active');
        updateStats();
      }
    }

    function saveState() {
      localStorage.setItem('allQuestions', JSON.stringify(allQuestions));
      localStorage.setItem('score', score.toString());
      localStorage.setItem('majorLevel', majorLevel.toString());
      localStorage.setItem('subLevel', subLevel.toString());
      localStorage.setItem('questionsInCurrentSubLevel', questionsInCurrentSubLevel.toString());
      localStorage.setItem('streak', streak.toString());
      // Save current screen state
      const currentScreen = document.getElementById('gameScreen').classList.contains('active') ? 'game' : 'selection';
      localStorage.setItem('currentScreen', currentScreen);
    }
    
    // Save state when page is about to unload (user navigates away)
    window.addEventListener('beforeunload', function() {
      saveState();
    });
    
    // Save state when page becomes hidden (user switches apps/tabs)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        saveState();
      }
    });
    
    // Load state on page load - wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadState);
    } else {
      // DOM is already ready
      loadState();
    }

    // Initialize major level buttons
    function initializeMajorLevelButtons() {
      const container = document.getElementById('majorLevelButtons');
      container.innerHTML = '';
      for (let i = 1; i <= TOTAL_MAJOR_LEVELS; i++) {
        const button = document.createElement('button');
        button.className = 'grade-button';
        button.textContent = `×¨××” ${i}`;
        button.onclick = () => selectMajorLevel(i);
        container.appendChild(button);
      }
    }

    function trackQuestion(question, correctAnswer, userAnswer, status) {
        // Generate unique ID for this question instance
        const questionId = `${question}_${Date.now()}_${Math.random()}`;
        currentQuestionId = questionId;
        
        const entry = {
            id: questionId,
            question: question,
            correctAnswer: correctAnswer,
            userAnswer: userAnswer || (status === 'skipped' ? '×“×™×œ×’/×”' : ''),
            status: status, // 'correct', 'wrong', or 'skipped'
            timestamp: Date.now()
        };
        console.log('Tracking question:', entry);
        allQuestions.push(entry);
        saveState();
        return questionId;
    }

    // Add event listener for Enter key on regular input
    document.getElementById('answer').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        checkAnswer();
      }
    });

    // Fix input handling for mobile
    const answerInput = document.getElementById('answer');
    const fractionWholeInput = document.getElementById('fractionWhole');
    const fractionNumeratorInput = document.getElementById('fractionNumerator');
    const fractionDenominatorInput = document.getElementById('fractionDenominator');
    const fractionInputWrapper = document.querySelector('.fraction-input-wrapper');
    
    // Make fraction inputs clickable/tappable - clicking wrapper focuses numerator
    if (fractionInputWrapper) {
      fractionInputWrapper.addEventListener('click', function(e) {
        // Only focus if clicking the wrapper itself, not the inputs
        if (e.target === fractionInputWrapper || e.target.classList.contains('fraction-input-line')) {
          e.preventDefault();
          fractionNumeratorInput.focus();
        }
      });
      
      // Also handle touch events for better mobile support
      fractionInputWrapper.addEventListener('touchend', function(e) {
        if (e.target === fractionInputWrapper || e.target.classList.contains('fraction-input-line')) {
          e.preventDefault();
          fractionNumeratorInput.focus();
        }
      }, { passive: false });
    }
    
    // Make whole number input more accessible - ensure it's clickable
    if (fractionWholeInput) {
      // Ensure the input itself is always focusable
      fractionWholeInput.addEventListener('touchstart', function() {
        this.focus();
      }, { passive: true });
      
      // Also handle click for desktop
      fractionWholeInput.addEventListener('click', function() {
        this.focus();
      });
    }
    
    // Make numerator and denominator inputs easily focusable
    [fractionNumeratorInput, fractionDenominatorInput].forEach(input => {
      if (input) {
        input.addEventListener('click', function() {
          this.focus();
        });
        
        input.addEventListener('touchstart', function() {
          this.focus();
        }, { passive: true });
      }
    });
    
    // Add event listeners for Enter key and arrow keys on fraction inputs
    fractionWholeInput.addEventListener('keydown', function(event) {
      if (event.key === 'Enter' || event.key === 'ArrowRight' || event.key === 'ArrowDown') {
        event.preventDefault();
        fractionNumeratorInput.focus();
      }
    });
    
    fractionNumeratorInput.addEventListener('keydown', function(event) {
      if (event.key === 'Enter' || event.key === 'ArrowDown') {
        event.preventDefault();
        fractionDenominatorInput.focus();
      } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') {
        event.preventDefault();
        fractionWholeInput.focus();
      }
    });

    fractionDenominatorInput.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        checkAnswer();
      } else if (event.key === 'ArrowUp' || event.key === 'ArrowLeft') {
        event.preventDefault();
        fractionNumeratorInput.focus();
      }
    });
    
    // Improve mobile input focus - make all fraction inputs easily tappable
    if (isMobile) {
      // Add touch handlers to make inputs more responsive
      [fractionWholeInput, fractionNumeratorInput, fractionDenominatorInput].forEach(input => {
        if (input) {
          input.addEventListener('touchstart', function() {
            this.focus();
            // Scroll input into view when keyboard appears
            setTimeout(() => {
              this.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
          }, { passive: true });
          
          // Ensure inputs are selectable
          input.style.webkitUserSelect = 'text';
          input.style.userSelect = 'text';
        }
      });
    }
    
    if (isMobile) {
      // Allow selection in the input fields
      answerInput.style.webkitUserSelect = 'text';
      answerInput.style.userSelect = 'text';
      fractionWholeInput.style.webkitUserSelect = 'text';
      fractionWholeInput.style.userSelect = 'text';
      fractionNumeratorInput.style.webkitUserSelect = 'text';
      fractionNumeratorInput.style.userSelect = 'text';
      fractionDenominatorInput.style.webkitUserSelect = 'text';
      fractionDenominatorInput.style.userSelect = 'text';
      
      // Make sure the input is properly sized and positioned
      answerInput.style.width = '90%';
      answerInput.style.maxWidth = '300px';
      answerInput.style.margin = '15px auto';
      answerInput.style.display = 'block';
      
      // Keep keyboard visible by maintaining focus
      function keepKeyboardVisible() {
        if (isFractionProblem) {
          fractionWholeInput.focus();
        } else {
          answerInput.focus();
        }
      }

      // Focus input when the game screen is shown
      document.getElementById('gameScreen').addEventListener('click', keepKeyboardVisible);
      
      // Focus input after each problem
      const originalGenerateProblem = generateProblem;
      generateProblem = function() {
        originalGenerateProblem();
        setTimeout(keepKeyboardVisible, 100);
      };

      // Focus input after checking answer
      const originalCheckAnswer = checkAnswer;
      checkAnswer = function() {
        originalCheckAnswer();
        setTimeout(keepKeyboardVisible, 1500);
      };
    }

    function selectMajorLevel(level) {
      majorLevel = level;
      subLevel = 1;
      questionsInCurrentSubLevel = 0;
      // Hide level selection and show game screen
      document.getElementById('gradeSelection').style.display = 'none';
      document.getElementById('gameScreen').classList.add('active');
      // Set level indicator
      document.getElementById('gradeIndicator').textContent = level;
      // Reset streak but keep score
      streak = 0;
      updateStats();
      saveState();
      generateProblem();
    }

    function returnToMainScreen() {
      // Show confirmation dialog (using plural form)
      Swal.fire({
        title: 'âš ï¸ ××™×¤×•×¡ ×¡×©×Ÿ',
        text: '×”×× ××ª× ×‘×˜×•×—×™×? ×–×” ×™××¤×¡ ××ª ×”×¡×©×Ÿ ×”× ×•×›×—×™',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '×›×Ÿ, ××¤×¡×•',
        cancelButtonText: '×‘×™×˜×•×œ',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#667eea',
        reverseButtons: false,
        customClass: {
          popup: 'rtl-popup'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          // Reset session
          score = 0;
          streak = 0;
          questionsInCurrentSubLevel = 0;
          allQuestions = [];
          
          // Clear localStorage
          localStorage.removeItem('score');
          localStorage.removeItem('streak');
          localStorage.removeItem('questionsInCurrentSubLevel');
          localStorage.removeItem('allQuestions');
          localStorage.removeItem('wrongQuestions'); // Remove old key if exists
          
          // Show level selection screen and hide game screen
          document.getElementById('gradeSelection').style.display = 'flex';
          document.getElementById('gameScreen').classList.remove('active');
          
          // Update stats display
          updateStats();
        }
      });
    }

    // Fraction utility functions
    function gcd(a, b) {
      return b === 0 ? a : gcd(b, a % b);
    }

    function simplifyFraction(numerator, denominator) {
      const divisor = gcd(Math.abs(numerator), Math.abs(denominator));
      return {
        numerator: numerator / divisor,
        denominator: denominator / divisor
      };
    }

    function parseFraction(str) {
      if (!str || str.trim() === '') return null;
      str = str.trim();
      
      // Check if it's a simple fraction like "3/4"
      if (str.includes('/')) {
        const parts = str.split('/');
        if (parts.length === 2) {
          const num = parseInt(parts[0]);
          const den = parseInt(parts[1]);
          if (!isNaN(num) && !isNaN(den) && den !== 0) {
            return simplifyFraction(num, den);
          }
        }
      }
      
      // Check if it's a whole number
      const num = parseFloat(str);
      if (!isNaN(num)) {
        return { numerator: num, denominator: 1 };
      }
      
      return null;
    }

    function fractionToString(fraction) {
      if (fraction.denominator === 1) {
        return fraction.numerator.toString();
      }
      return `${fraction.numerator}/${fraction.denominator}`;
    }

    function fractionToHTML(fraction) {
      if (fraction.denominator === 1) {
        return fraction.numerator.toString();
      }
      return `<span class="fraction"><span class="fraction-numerator">${fraction.numerator}</span><span class="fraction-denominator">${fraction.denominator}</span></span>`;
    }

    function fractionsEqual(f1, f2) {
      // Simplify both fractions before comparing
      const simplified1 = simplifyFraction(f1.numerator, f1.denominator);
      const simplified2 = simplifyFraction(f2.numerator, f2.denominator);
      // Compare simplified forms - this handles equivalent fractions like 10/5 = 2/1
      return simplified1.numerator === simplified2.numerator && simplified1.denominator === simplified2.denominator;
    }

    // Calculate effective level for problem difficulty
    function getEffectiveLevel() {
      return (majorLevel - 1) * SUB_LEVELS_PER_MAJOR + subLevel;
    }

    function generateFractionProblem() {
      isFractionProblem = true;
      const effectiveLevel = getEffectiveLevel();
      
      // Determine which operations and complexity based on level
      // Start with simple same-denominator addition only
      let operations = [];
      let maxDenominator = 4;
      let allowDifferentDenominators = false;
      let allowMixedNumbers = false;
      
      if (effectiveLevel <= 5) {
        // Very early: Only addition with same denominator, small numbers
        operations = ['+'];
        maxDenominator = 4;
        allowDifferentDenominators = false;
      } else if (effectiveLevel <= 10) {
        // Early: Addition and subtraction with same denominator
        operations = ['+', '-'];
        maxDenominator = 5;
        allowDifferentDenominators = false;
      } else if (effectiveLevel <= 15) {
        // Mid-early: Same denominator, slightly larger
        operations = ['+', '-'];
        maxDenominator = 6;
        allowDifferentDenominators = false;
      } else if (effectiveLevel <= 25) {
        // Mid: Addition/subtraction with different denominators (simple)
        operations = ['+', '-'];
        maxDenominator = 6;
        allowDifferentDenominators = true;
      } else if (effectiveLevel <= 40) {
        // Mid-advanced: All operations, different denominators
        operations = ['+', '-', 'Ã—'];
        maxDenominator = 8;
        allowDifferentDenominators = true;
      } else {
        // Advanced: All operations including division
        operations = ['+', '-', 'Ã—', 'Ã·'];
        maxDenominator = 10;
        allowDifferentDenominators = true;
      }
      
      const operation = operations[Math.floor(Math.random() * operations.length)];
      
      let f1, f2;
      const availableDenominators = [2, 3, 4, 5, 6, 8, 10].filter(d => d <= maxDenominator);
      if (availableDenominators.length === 0) availableDenominators.push(2);
      
      if (operation === '+' || operation === '-') {
        if (allowDifferentDenominators && effectiveLevel > 15 && Math.random() < 0.5) {
          // Different denominators (but keep them simple)
          const d1 = availableDenominators[Math.floor(Math.random() * Math.min(availableDenominators.length, 4))];
          let d2 = availableDenominators[Math.floor(Math.random() * Math.min(availableDenominators.length, 4))];
          // Prefer denominators that are multiples or factors of each other for easier calculation
          if (d1 === 2 && d2 === 4) d2 = 4;
          else if (d1 === 2 && d2 === 6) d2 = 6;
          else if (d1 === 3 && d2 === 6) d2 = 6;
          else if (d1 === 2 && d2 === 8) d2 = 8;
          else if (d1 === 4 && d2 === 8) d2 = 8;
          
          f1 = {
            numerator: Math.floor(Math.random() * d1) + 1,
            denominator: d1
          };
          f2 = {
            numerator: Math.floor(Math.random() * d2) + 1,
            denominator: d2
          };
        } else {
          // Same denominator (simpler)
          const denominator = availableDenominators[
            Math.floor(Math.random() * availableDenominators.length)
          ];
          // Keep numerators smaller for easier problems
          const maxNumerator = effectiveLevel <= 10 ? denominator : denominator * 2;
          f1 = {
            numerator: Math.floor(Math.random() * (maxNumerator - 1)) + 1,
            denominator: denominator
          };
          f2 = {
            numerator: Math.floor(Math.random() * (maxNumerator - 1)) + 1,
            denominator: denominator
          };
          
          // For subtraction, ensure result is positive
          if (operation === '-' && f1.numerator < f2.numerator) {
            [f1, f2] = [f2, f1];
          }
        }
      } else {
        // Multiplication/division - keep denominators simple
        const d1 = availableDenominators[Math.floor(Math.random() * Math.min(availableDenominators.length, 4))];
        const d2 = availableDenominators[Math.floor(Math.random() * Math.min(availableDenominators.length, 4))];
        f1 = {
          numerator: Math.floor(Math.random() * d1) + 1,
          denominator: d1
        };
        f2 = {
          numerator: Math.floor(Math.random() * d2) + 1,
          denominator: d2
        };
      }
      
      // Calculate answer
      let result;
      switch(operation) {
        case '+':
          if (f1.denominator === f2.denominator) {
            result = simplifyFraction(f1.numerator + f2.numerator, f1.denominator);
          } else {
            result = simplifyFraction(
              f1.numerator * f2.denominator + f2.numerator * f1.denominator,
              f1.denominator * f2.denominator
            );
          }
          break;
        case '-':
          if (f1.denominator === f2.denominator) {
            result = simplifyFraction(f1.numerator - f2.numerator, f1.denominator);
          } else {
            const num = f1.numerator * f2.denominator - f2.numerator * f1.denominator;
            if (num < 0) {
              [f1, f2] = [f2, f1];
              result = simplifyFraction(
                f1.numerator * f2.denominator - f2.numerator * f1.denominator,
                f1.denominator * f2.denominator
              );
            } else {
              result = simplifyFraction(num, f1.denominator * f2.denominator);
            }
          }
          break;
        case 'Ã—':
          result = simplifyFraction(
            f1.numerator * f2.numerator,
            f1.denominator * f2.denominator
          );
          break;
        case 'Ã·':
          const temp = f1.numerator * f2.denominator;
          const tempDen = f1.denominator * f2.numerator;
          result = simplifyFraction(temp, tempDen);
          break;
      }
      
      currentAnswer = result;
      currentProblem = `${fractionToString(f1)} ${operation} ${fractionToString(f2)} =`;
      currentQuestionId = null; // Reset for new question
      
      // Store problem parameters for retry
      lastProblemParams = {
        type: 'fraction',
        f1: { numerator: f1.numerator, denominator: f1.denominator },
        f2: { numerator: f2.numerator, denominator: f2.denominator },
        operation: operation
      };
      
      // Display as proper fraction using HTML
      const problemElement = document.getElementById('problem');
      problemElement.innerHTML = `${fractionToHTML(f1)} ${operation} ${fractionToHTML(f2)} =`;
      
      // Show fraction input, hide regular input
      document.getElementById('answer').classList.add('hidden');
      document.getElementById('answer').style.display = 'none'; // Ensure hidden
      document.getElementById('fractionInput').classList.add('active');
      document.getElementById('fractionInput').style.display = 'block'; // Ensure visible after popup
      document.getElementById('fractionWhole').value = '';
      document.getElementById('fractionNumerator').value = '';
      document.getElementById('fractionDenominator').value = '';
      
      // Focus whole number input, and ensure it's visible on mobile
      setTimeout(() => {
        const wholeInput = document.getElementById('fractionWhole');
        wholeInput.focus();
        // On mobile, scroll input into view
        if (isMobile) {
          setTimeout(() => {
            wholeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        }
      }, 50);
      
      document.getElementById('feedbackText').textContent = '';
      document.getElementById('feedback').className = 'feedback';
      document.getElementById('wrongAnswerActions').style.display = 'none';
      document.getElementById('revealedAnswer').style.display = 'none';
    }

    function generateProblem() {
      const effectiveLevel = getEffectiveLevel();
      isFractionProblem = false;
      
      // Start introducing fractions from Major Level 4, Sub-level 1 onwards
      const fractionStartLevel = (4 - 1) * SUB_LEVELS_PER_MAJOR + 1; // Level 31
      let fractionProbability = 0;
      
      if (effectiveLevel >= fractionStartLevel) {
        // Gradually increase fraction probability
        if (effectiveLevel <= 40) {
          fractionProbability = 0.2; // 20% chance - simple fractions only
        } else if (effectiveLevel <= 50) {
          fractionProbability = 0.3; // 30% chance
        } else if (effectiveLevel <= 70) {
          fractionProbability = 0.4; // 40% chance
        } else {
          fractionProbability = 0.5; // 50% chance at higher levels
        }
      }
      
      const shouldUseFractions = effectiveLevel >= fractionStartLevel && Math.random() < fractionProbability;
      
      if (shouldUseFractions) {
        generateFractionProblem();
        return;
      }
      
      // Regular number problems - filter operations based on major level
      let num1, num2, operation;
      let availableOperations = [];
      
      // Major Level 1: Only addition and subtraction
      if (majorLevel === 1) {
        availableOperations = ['+', '-'];
      }
      // Major Level 2: Addition, subtraction, and gradually introduce multiplication (by 10, 100)
      else if (majorLevel === 2) {
        if (subLevel <= 5) {
          // First half: mostly addition/subtraction, occasional multiplication by 10
          availableOperations = ['+', '-'];
          if (Math.random() < 0.2) { // 20% chance for multiplication
            availableOperations = ['Ã—'];
          }
        } else {
          // Second half: more multiplication by 10 and 100
          availableOperations = ['+', '-', 'Ã—'];
        }
      }
      // Major Level 3: All operations including general multiplication and gradually add division
      else if (majorLevel === 3) {
        if (subLevel <= 5) {
          // First half: addition, subtraction, general multiplication
          availableOperations = ['+', '-', 'Ã—'];
        } else {
          // Second half: add division gradually
          availableOperations = ['+', '-', 'Ã—', 'Ã·'];
        }
      }
      // Major Level 4+: All operations (fractions handled separately above)
      else {
        availableOperations = ['+', '-', 'Ã—', 'Ã·'];
      }
      
      operation = availableOperations[Math.floor(Math.random() * availableOperations.length)];
      
      // Determine number ranges based on effective level
      switch(operation) {
        case '+':
          if (effectiveLevel <= 5) {
            // One-digit addition (no carrying)
            num1 = Math.floor(Math.random() * 9) + 1;
            num2 = Math.floor(Math.random() * (9 - num1)) + 1;
          } else if (effectiveLevel <= 10) {
            // Two-digit with one-digit addition (no carrying)
            num1 = Math.floor(Math.random() * 89) + 10;
            const ones = num1 % 10;
            num2 = Math.floor(Math.random() * (9 - ones)) + 1;
          } else if (effectiveLevel <= 15) {
            // One-digit addition (with carrying)
            num1 = Math.floor(Math.random() * 9) + 1;
            num2 = Math.floor(Math.random() * (19 - num1)) + 1;
          } else if (effectiveLevel <= 20) {
            // Two-digit with one-digit addition (with carrying)
            num1 = Math.floor(Math.random() * 89) + 10;
            num2 = Math.floor(Math.random() * 9) + 1;
          } else if (effectiveLevel <= 30) {
            // Two-digit with two-digit addition (with carrying)
            num1 = Math.floor(Math.random() * 89) + 10;
            num2 = Math.floor(Math.random() * 89) + 10;
          } else if (effectiveLevel <= 50) {
            // Three-digit addition
            num1 = Math.floor(Math.random() * 900) + 100;
            num2 = Math.floor(Math.random() * 900) + 100;
          } else {
            // Larger numbers
            num1 = Math.floor(Math.random() * 9000) + 1000;
            num2 = Math.floor(Math.random() * 9000) + 1000;
          }
          break;
          
        case '-':
          if (effectiveLevel <= 5) {
            // One-digit subtraction (positive result)
            num1 = Math.floor(Math.random() * 9) + 1;
            num2 = Math.floor(Math.random() * num1);
          } else if (effectiveLevel <= 10) {
            // Two-digit with one-digit subtraction (no borrowing)
            num1 = Math.floor(Math.random() * 89) + 10;
            const ones = num1 % 10;
            num2 = Math.floor(Math.random() * ones);
          } else if (effectiveLevel <= 15) {
            // One-digit subtraction (with borrowing)
            num1 = Math.floor(Math.random() * 9) + 1;
            num2 = Math.floor(Math.random() * 9) + 1;
            if (num1 < num2) [num1, num2] = [num2, num1];
          } else if (effectiveLevel <= 20) {
            // Two-digit with one-digit subtraction (with borrowing)
            num1 = Math.floor(Math.random() * 89) + 10;
            num2 = Math.floor(Math.random() * 9) + 1;
            if (num1 < num2) [num1, num2] = [num2, num1];
          } else if (effectiveLevel <= 30) {
            // Two-digit with two-digit subtraction (with borrowing)
            num1 = Math.floor(Math.random() * 89) + 10;
            num2 = Math.floor(Math.random() * 89) + 10;
            if (num1 < num2) [num1, num2] = [num2, num1];
          } else if (effectiveLevel <= 50) {
            // Three-digit subtraction
            num1 = Math.floor(Math.random() * 900) + 100;
            num2 = Math.floor(Math.random() * 900) + 100;
            if (num1 < num2) [num1, num2] = [num2, num1];
          } else {
            // Larger numbers
            num1 = Math.floor(Math.random() * 9000) + 1000;
            num2 = Math.floor(Math.random() * 9000) + 1000;
            if (num1 < num2) [num1, num2] = [num2, num1];
          }
          break;
          
        case 'Ã—':
          // Major Level 2: Multiplication by 10 or 100
          if (majorLevel === 2) {
            if (subLevel <= 5) {
              // First half: multiplication by 10
              num1 = Math.floor(Math.random() * 9) + 1;
              num2 = 10;
            } else {
              // Second half: multiplication by 10 or 100
              num1 = Math.floor(Math.random() * 9) + 1;
              num2 = Math.random() < 0.5 ? 10 : 100;
            }
          }
          // Major Level 3+: General multiplications
          else if (effectiveLevel <= 30) {
            // Two-digit by one-digit (simple multiplications)
            num1 = Math.floor(Math.random() * 90) + 10;
            num2 = Math.floor(Math.random() * 9) + 1;
          } else if (effectiveLevel <= 50) {
            // Two-digit by two-digit
            num1 = Math.floor(Math.random() * 90) + 10;
            num2 = Math.floor(Math.random() * 90) + 10;
          } else {
            // Three-digit by one-digit
            num1 = Math.floor(Math.random() * 900) + 100;
            num2 = Math.floor(Math.random() * 9) + 1;
          }
          break;
          
        case 'Ã·':
          // Division only appears in Major Level 3+
          if (majorLevel === 3) {
            if (subLevel <= 5) {
              // First half: simple division (up to 12)
              num2 = Math.floor(Math.random() * 12) + 1;
              num1 = num2 * (Math.floor(Math.random() * 12) + 1);
            } else {
              // Second half: two-digit division
              num2 = Math.floor(Math.random() * 12) + 1;
              num1 = num2 * (Math.floor(Math.random() * 90) + 10);
            }
          } else if (effectiveLevel <= 50) {
            // Two-digit division
            num2 = Math.floor(Math.random() * 12) + 1;
            num1 = num2 * (Math.floor(Math.random() * 90) + 10);
          } else {
            // Three-digit division
            num2 = Math.floor(Math.random() * 12) + 1;
            num1 = num2 * (Math.floor(Math.random() * 900) + 100);
          }
          break;
      }

      currentProblem = `${num1} ${operation} ${num2} =`;
      currentAnswer = eval(currentProblem.replace('Ã—', '*').replace('Ã·', '/').replace('=', ''));
      currentQuestionId = null; // Reset for new question
      
      // Store problem parameters for retry
      lastProblemParams = {
        type: 'regular',
        num1: num1,
        num2: num2,
        operation: operation
      };
      
      document.getElementById('problem').textContent = currentProblem;
      
      // Show regular input, hide fraction input
      document.getElementById('answer').classList.remove('hidden');
      document.getElementById('answer').style.display = 'block'; // Ensure visible after popup
      document.getElementById('fractionInput').classList.remove('active');
      document.getElementById('fractionInput').style.display = 'none'; // Ensure hidden
      document.getElementById('answer').value = '';
      document.getElementById('answer').focus();
      
      document.getElementById('feedbackText').textContent = '';
      document.getElementById('feedback').className = 'feedback';
      document.getElementById('wrongAnswerActions').style.display = 'none';
      document.getElementById('revealedAnswer').style.display = 'none';
    }

    function checkAnswer() {
      const feedback = document.getElementById('feedback');
      let isCorrect = false;
      let userAnswerDisplay = '';
      
      if (isFractionProblem) {
        // Read from fraction inputs (including whole number)
        const wholeNumber = parseInt(document.getElementById('fractionWhole').value) || 0;
        const numerator = parseInt(document.getElementById('fractionNumerator').value);
        const denominator = parseInt(document.getElementById('fractionDenominator').value);
        
        // Check if at least whole number or fraction is provided
        const hasWhole = !isNaN(wholeNumber) && wholeNumber > 0;
        const hasNumerator = !isNaN(numerator) && numerator > 0;
        const hasDenominator = !isNaN(denominator) && denominator > 0;
        
        if (!hasWhole && !hasNumerator && !hasDenominator) {
          if (isMobile) {
            Swal.fire({
              title: '×× × ×”×›× ×¡ ×ª×©×•×‘×”',
              icon: 'warning',
              confirmButtonText: '××™×©×•×¨',
              confirmButtonColor: '#667eea'
            });
          } else {
            document.getElementById('feedbackText').textContent = '×× × ×”×›× ×¡ ×ª×©×•×‘×”';
            feedback.className = 'feedback incorrect';
            document.getElementById('wrongAnswerActions').style.display = 'none';
            document.getElementById('revealedAnswer').style.display = 'none';
          }
          return;
        }
        
        // Build the user's answer as a fraction
        let userFraction;
        if (hasNumerator && hasDenominator) {
          // Has fraction part
          if (denominator <= 0) {
            if (isMobile) {
              Swal.fire({
                title: '×”××›× ×” ×—×™×™×‘ ×œ×”×™×•×ª ×’×“×•×œ ×-0',
                icon: 'error',
                confirmButtonText: '××™×©×•×¨',
                confirmButtonColor: '#667eea'
              });
            } else {
              document.getElementById('feedbackText').textContent = '×”××›× ×” ×—×™×™×‘ ×œ×”×™×•×ª ×’×“×•×œ ×-0';
              feedback.className = 'feedback incorrect';
              document.getElementById('wrongAnswerActions').style.display = 'none';
              document.getElementById('revealedAnswer').style.display = 'none';
            }
            return;
          }
          // Combine whole number and fraction: whole * denominator + numerator
          const totalNumerator = wholeNumber * denominator + numerator;
          userFraction = simplifyFraction(totalNumerator, denominator);
        } else if (hasWhole) {
          // Only whole number provided
          userFraction = simplifyFraction(wholeNumber, 1);
        } else {
          if (isMobile) {
            Swal.fire({
              title: '×× × ×”×›× ×¡ ×©×‘×¨ ×ª×§×™×Ÿ (××•× ×” ×•××›× ×”)',
              icon: 'warning',
              confirmButtonText: '××™×©×•×¨',
              confirmButtonColor: '#667eea'
            });
          } else {
            document.getElementById('feedbackText').textContent = '×× × ×”×›× ×¡ ×©×‘×¨ ×ª×§×™×Ÿ (××•× ×” ×•××›× ×”)';
            feedback.className = 'feedback incorrect';
            document.getElementById('wrongAnswerActions').style.display = 'none';
            document.getElementById('revealedAnswer').style.display = 'none';
          }
          return;
        }
        
        // Compare simplified fractions - this ensures equivalent forms are accepted
        // (e.g., 10/5 = 2/1 = 2)
        isCorrect = fractionsEqual(userFraction, currentAnswer);
        
        // Format display string
        if (userFraction.denominator === 1) {
          userAnswerDisplay = userFraction.numerator.toString();
        } else {
          const wholePart = Math.floor(userFraction.numerator / userFraction.denominator);
          const remainder = userFraction.numerator % userFraction.denominator;
          if (wholePart > 0 && remainder > 0) {
            userAnswerDisplay = `${wholePart} ${remainder}/${userFraction.denominator}`;
          } else {
            userAnswerDisplay = fractionToString(userFraction);
          }
        }
      } else {
        // Read from regular input
        const answerInput = document.getElementById('answer').value.trim();
        if (!answerInput) {
          if (isMobile) {
            Swal.fire({
              title: '×× × ×”×›× ×¡ ×ª×©×•×‘×”',
              icon: 'warning',
              confirmButtonText: '××™×©×•×¨',
              confirmButtonColor: '#667eea'
            });
          } else {
            document.getElementById('feedbackText').textContent = '×× × ×”×›× ×¡ ×ª×©×•×‘×”';
            feedback.className = 'feedback incorrect';
            document.getElementById('wrongAnswerActions').style.display = 'none';
            document.getElementById('revealedAnswer').style.display = 'none';
          }
          return;
        }
        const userAnswer = parseFloat(answerInput);
        if (isNaN(userAnswer)) {
          if (isMobile) {
            Swal.fire({
              title: '×× × ×”×›× ×¡ ××¡×¤×¨ ×ª×§×™×Ÿ',
              icon: 'warning',
              confirmButtonText: '××™×©×•×¨',
              confirmButtonColor: '#667eea'
            });
          } else {
            document.getElementById('feedbackText').textContent = '×× × ×”×›× ×¡ ××¡×¤×¨ ×ª×§×™×Ÿ';
            feedback.className = 'feedback incorrect';
            document.getElementById('wrongAnswerActions').style.display = 'none';
            document.getElementById('revealedAnswer').style.display = 'none';
          }
          return;
        }
        isCorrect = Math.abs(userAnswer - currentAnswer) < 0.001; // Handle floating point precision
        userAnswerDisplay = userAnswer.toString();
      }

      if (isCorrect) {
        score += 10;
        streak++;
        questionsInCurrentSubLevel++;
        
        let bonusMessage = '';
        let levelUpOccurred = false;
        
        // Check for sub-level progression
        if (questionsInCurrentSubLevel >= QUESTIONS_PER_SUB_LEVEL) {
          subLevel++;
          questionsInCurrentSubLevel = 0;
          
          // Check if we've completed all sub-levels in current major level
          if (subLevel > SUB_LEVELS_PER_MAJOR) {
            // Move to next major level
            majorLevel++;
            subLevel = 1;
            
            if (majorLevel <= TOTAL_MAJOR_LEVELS) {
              const majorBonus = 50;
              score += majorBonus;
              bonusMessage = `ğŸ‰ ×‘×•× ×•×¡ ×¨××” ×¨××©×™×ª: +${majorBonus} × ×§×•×“×•×ª! `;
              showAchievement(`×¢×œ×™×ª ×œ×¨××” ×¨××©×™×ª ${majorLevel}! ğŸ¯`);
              levelUpOccurred = true;
            } else {
              // Already at max level, reset sub-level
              subLevel = SUB_LEVELS_PER_MAJOR;
              questionsInCurrentSubLevel = QUESTIONS_PER_SUB_LEVEL;
            }
          } else {
            // Sub-level progression
            const subBonus = 20;
            score += subBonus;
            bonusMessage = `â­ ×‘×•× ×•×¡ ×ª×ª ×¨××”: +${subBonus} × ×§×•×“×•×ª! `;
            showAchievement(`×¢×œ×™×ª ×œ×ª×ª ×¨××” ${subLevel}! ğŸŒŸ`);
            levelUpOccurred = true;
          }
        }
        
        // Track correct answer (always track every attempt)
        const correctAnswerStr = isFractionProblem 
          ? fractionToString(currentAnswer) 
          : currentAnswer.toString();
        trackQuestion(currentProblem, correctAnswerStr, userAnswerDisplay, 'correct');
        
        document.getElementById('feedbackText').textContent = bonusMessage + '×›×œ ×”×›×‘×•×“! ×ª×©×•×‘×” × ×›×•× ×”! ğŸ‰';
        feedback.className = 'feedback correct';
        document.getElementById('wrongAnswerActions').style.display = 'none';
        document.getElementById('revealedAnswer').style.display = 'none';
        
        if (streak % 5 === 0 && !levelUpOccurred) {
          showAchievement(`×¨×¦×£ ×©×œ ${streak} ×ª×©×•×‘×•×ª × ×›×•× ×•×ª! ğŸŒŸ`);
        }
      } else {
        streak = 0;
        const correctAnswerStr = isFractionProblem 
          ? fractionToString(currentAnswer) 
          : currentAnswer.toString();
        
        // Store correct answer for reveal function
        window.currentCorrectAnswer = correctAnswerStr;
        
        // Track wrong answer (always track, even on retry)
        trackQuestion(currentProblem, correctAnswerStr, userAnswerDisplay, 'wrong');
        
        // Show error as popup for ALL devices and hide input
        // Hide input fields
        document.getElementById('answer').style.display = 'none';
        document.getElementById('fractionInput').style.display = 'none';
        
        // Show error popup with action buttons (right to left: reveal answer, try again)
        Swal.fire({
          title: '×˜×¢×•×ª',
          text: '×”×ª×©×•×‘×” ×©×’×•×™×”. ××” ×ª×¨×¦×” ×œ×¢×©×•×ª?',
          icon: 'error',
          showCancelButton: false,
          showDenyButton: true,
          confirmButtonText: '×’×œ×” ×ª×©×•×‘×”',
          denyButtonText: '× ×¡×” ×©×•×‘',
          confirmButtonColor: '#f59e0b',
          denyButtonColor: '#667eea',
          reverseButtons: true, // Right to left: reveal answer (right), try again (left)
          customClass: {
            popup: 'rtl-popup'
          }
        }).then((result) => {
          // Show input fields again
          if (isFractionProblem) {
            document.getElementById('fractionInput').style.display = 'block';
          } else {
            document.getElementById('answer').style.display = 'block';
          }
          
          if (result.isConfirmed) {
            // Reveal answer - show correct answer and continue button
            const correctAnswerStr = window.currentCorrectAnswer || (isFractionProblem 
              ? fractionToString(currentAnswer) 
              : currentAnswer.toString());
            
            let answerDisplay = '';
            if (isFractionProblem && currentAnswer && currentAnswer.denominator !== 1) {
              answerDisplay = `×”×ª×©×•×‘×” ×”× ×›×•× ×” ×”×™×: ${fractionToHTML(currentAnswer)}`;
            } else {
              answerDisplay = `×”×ª×©×•×‘×” ×”× ×›×•× ×” ×”×™×: ${correctAnswerStr}`;
            }
            
            // Show popup with answer and continue button
            Swal.fire({
              title: '×”×ª×©×•×‘×” ×”× ×›×•× ×”',
              html: `<div style="font-size: 20px; margin: 20px 0;">${answerDisplay}</div>`,
              icon: 'info',
              confirmButtonText: '×”××©×š',
              confirmButtonColor: '#10b981',
              customClass: {
                popup: 'rtl-popup'
              }
            }).then(() => {
              continueToNext();
            });
          } else if (result.isDenied) {
            // Try again
            retryQuestion();
          }
        });
      }

      updateStats();
      saveState();
      
      // Only auto-advance for correct answers
      if (isCorrect) {
        setTimeout(generateProblem, 1500);
      }
    }

    function updateStats() {
      document.getElementById('score').textContent = score;
      document.getElementById('majorLevel').textContent = majorLevel;
      document.getElementById('subLevel').textContent = subLevel;
      document.getElementById('streak').textContent = streak;
      // Progress bar shows progress within current sub-level
      const progressPercent = (questionsInCurrentSubLevel / QUESTIONS_PER_SUB_LEVEL) * 100;
      document.getElementById('progressFill').style.width = `${progressPercent}%`;
    }

    function retryQuestion() {
      if (!lastProblemParams) {
        generateProblem();
        return;
      }
      
      // Ensure input fields are visible
      if (isFractionProblem) {
        document.getElementById('fractionInput').style.display = 'block';
      } else {
        document.getElementById('answer').style.display = 'block';
      }
      
      // Clear feedback and hide buttons
      document.getElementById('feedbackText').textContent = '';
      document.getElementById('feedback').className = 'feedback';
      document.getElementById('wrongAnswerActions').style.display = 'none';
      document.getElementById('revealedAnswer').style.display = 'none';
      
      // Regenerate the same problem
      if (lastProblemParams.type === 'fraction') {
        const f1 = { numerator: lastProblemParams.f1.numerator, denominator: lastProblemParams.f1.denominator };
        const f2 = { numerator: lastProblemParams.f2.numerator, denominator: lastProblemParams.f2.denominator };
        const operation = lastProblemParams.operation;
        
        // Recalculate answer
        let result;
        switch(operation) {
          case '+':
            if (f1.denominator === f2.denominator) {
              result = simplifyFraction(f1.numerator + f2.numerator, f1.denominator);
            } else {
              result = simplifyFraction(
                f1.numerator * f2.denominator + f2.numerator * f1.denominator,
                f1.denominator * f2.denominator
              );
            }
            break;
          case '-':
            if (f1.denominator === f2.denominator) {
              result = simplifyFraction(f1.numerator - f2.numerator, f1.denominator);
            } else {
              const num = f1.numerator * f2.denominator - f2.numerator * f1.denominator;
              if (num < 0) {
                const temp = { numerator: f2.numerator, denominator: f2.denominator };
                const temp2 = { numerator: f1.numerator, denominator: f1.denominator };
                result = simplifyFraction(
                  temp.numerator * temp2.denominator - temp2.numerator * temp.denominator,
                  temp.denominator * temp2.denominator
                );
              } else {
                result = simplifyFraction(num, f1.denominator * f2.denominator);
              }
            }
            break;
          case 'Ã—':
            result = simplifyFraction(
              f1.numerator * f2.numerator,
              f1.denominator * f2.denominator
            );
            break;
          case 'Ã·':
            const temp = f1.numerator * f2.denominator;
            const tempDen = f1.denominator * f2.numerator;
            result = simplifyFraction(temp, tempDen);
            break;
        }
        
        currentAnswer = result;
        currentProblem = `${fractionToString(f1)} ${operation} ${fractionToString(f2)} =`;
        
        // Display as proper fraction using HTML
        const problemElement = document.getElementById('problem');
        problemElement.innerHTML = `${fractionToHTML(f1)} ${operation} ${fractionToHTML(f2)} =`;
        
        // Show fraction input, hide regular input
        isFractionProblem = true;
        document.getElementById('answer').classList.add('hidden');
        document.getElementById('fractionInput').classList.add('active');
        document.getElementById('fractionWhole').value = '';
        document.getElementById('fractionNumerator').value = '';
        document.getElementById('fractionDenominator').value = '';
        
        // Focus whole number input, and ensure it's visible on mobile
        setTimeout(() => {
          const wholeInput = document.getElementById('fractionWhole');
          wholeInput.focus();
          // On mobile, scroll input into view
          if (isMobile) {
            setTimeout(() => {
              wholeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
          }
        }, 50);
      } else {
        // Regular problem
        const num1 = lastProblemParams.num1;
        const num2 = lastProblemParams.num2;
        const operation = lastProblemParams.operation;
        
        currentProblem = `${num1} ${operation} ${num2} =`;
        currentAnswer = eval(currentProblem.replace('Ã—', '*').replace('Ã·', '/').replace('=', ''));
        
        document.getElementById('problem').textContent = currentProblem;
        
        // Show regular input, hide fraction input
        isFractionProblem = false;
        document.getElementById('answer').classList.remove('hidden');
        document.getElementById('fractionInput').classList.remove('active');
        document.getElementById('answer').value = '';
        document.getElementById('answer').focus();
      }
    }

    function revealAnswer() {
      // Hide action buttons and show the answer
      document.getElementById('wrongAnswerActions').style.display = 'none';
      document.getElementById('revealedAnswer').style.display = 'block';
      
      // Display the correct answer
      const correctAnswerStr = window.currentCorrectAnswer || (isFractionProblem 
        ? fractionToString(currentAnswer) 
        : currentAnswer.toString());
      
      // Format answer display - if it's a fraction, use HTML formatting
      if (isFractionProblem && currentAnswer && currentAnswer.denominator !== 1) {
        document.getElementById('revealedAnswerText').innerHTML = `×”×ª×©×•×‘×” ×”× ×›×•× ×” ×”×™×: ${fractionToHTML(currentAnswer)}`;
      } else {
        document.getElementById('revealedAnswerText').textContent = `×”×ª×©×•×‘×” ×”× ×›×•× ×” ×”×™×: ${correctAnswerStr}`;
      }
    }

    function continueToNext() {
      // Clear feedback and generate next problem
      document.getElementById('feedbackText').textContent = '';
      document.getElementById('feedback').className = 'feedback';
      document.getElementById('wrongAnswerActions').style.display = 'none';
      document.getElementById('revealedAnswer').style.display = 'none';
      
      // Ensure input fields are visible
      if (isFractionProblem) {
        document.getElementById('fractionInput').style.display = 'block';
      } else {
        document.getElementById('answer').style.display = 'block';
      }
      
      generateProblem();
    }

    function newProblem() {
      const correctAnswerStr = isFractionProblem 
        ? fractionToString(currentAnswer) 
        : currentAnswer.toString();
      
      // Track skipped question (always track)
      trackQuestion(currentProblem, correctAnswerStr, '×“×™×œ×’/×”', 'skipped');
      
      score = Math.max(0, score - 5);
      updateStats();
      saveState();
      
      // Ensure input fields are visible before generating new problem
      if (isFractionProblem) {
        document.getElementById('fractionInput').style.display = 'block';
        document.getElementById('answer').style.display = 'none';
      } else {
        document.getElementById('answer').style.display = 'block';
        document.getElementById('fractionInput').style.display = 'none';
      }
      
      generateProblem();
    }

    function changeDifficulty() {
      // Allow manual level change - move to next sub-level
      subLevel++;
      if (subLevel > SUB_LEVELS_PER_MAJOR) {
        majorLevel++;
        subLevel = 1;
        if (majorLevel > TOTAL_MAJOR_LEVELS) {
          majorLevel = TOTAL_MAJOR_LEVELS;
          subLevel = SUB_LEVELS_PER_MAJOR;
        }
      }
      questionsInCurrentSubLevel = 0;
      showAchievement(`×©×™× ×™×ª ×œ×¨××” ×¨××©×™×ª ${majorLevel}, ×ª×ª ×¨××” ${subLevel}`);
      updateStats();
      saveState();
      generateProblem();
    }

    function showAchievement(message) {
      const achievement = document.createElement('div');
      achievement.className = 'achievement';
      achievement.textContent = message;
      document.body.appendChild(achievement);
      
      // Ensure the achievement is visible when keyboard is shown
      if (isMobile) {
        // Force the achievement to stay on top
        achievement.style.zIndex = '9999';
        
        // Add a small delay to ensure proper positioning
        setTimeout(() => {
          achievement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
      
      setTimeout(() => {
        achievement.remove();
      }, 3000);
    }

    async function shareReport() {
      const { value: studentName } = await Swal.fire({
        title: '×©× ×”×ª×œ××™×“/×”',
        input: 'text',
        inputLabel: '×‘×‘×§×©×” ×¨×™×©××• ××ª ×©××›×',
        inputValidator: (value) => {
          if (!value) {
            return '×—×•×‘×” ×œ×”×›× ×™×¡ ×©×';
          }
        },
        confirmButtonText: '×©×œ×—',
        showCancelButton: true,
        cancelButtonText: '×‘×˜×œ',
        didOpen: () => {
          setTimeout(() => {
            document.querySelector('.swal2-input').focus();
          }, 100);
        }
      });

      if (studentName) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB').split('/').join('-');
        const timeStr = `${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;
        
        // Clean file name - remove special characters that might cause issues
        const cleanStudentName = studentName.replace(/[<>:"/\\|?*;]/g, '_').trim();
        const fileName = `${cleanStudentName}_${dateStr}_${timeStr}.pdf`;
        
        if (isMobile && navigator.share) {
          try {
            // Generate PDF using the same function as desktop
            window.jsPDF = window.jspdf.jsPDF;
            const doc = generateReportWithFileName(fileName, true); // Pass true to indicate we want the doc returned
            
            if (!doc) {
              throw new Error('PDF generation returned null');
            }
            
            // Generate PDF as data URL first to ensure it's complete
            const pdfDataUrl = doc.output('dataurlstring');
            
            // Convert data URL to blob
            const response = await fetch(pdfDataUrl);
            const pdfBlob = await response.blob();
            
            // Verify blob is valid
            if (!pdfBlob || pdfBlob.size === 0) {
              throw new Error('PDF generation failed - empty blob');
            }
            
            // Create file for sharing - ensure proper MIME type
            const file = new File([pdfBlob], fileName, { 
              type: 'application/pdf',
              lastModified: Date.now()
            });
            
            // Verify file was created correctly
            if (!file || file.size === 0) {
              throw new Error('File creation failed');
            }
            
            // Share the file
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({
                files: [file],
                title: 'Math Practice Report',
                text: 'Math Practice Report for ' + studentName
              });
              
              // Show success message
              Swal.fire({
                icon: 'success',
                title: '×“×•×— × ×©×œ×— ×‘×”×¦×œ×—×”!',
                text: '×”×“×•×— × ×©×œ×— ×‘×”×¦×œ×—×”',
                timer: 2000,
                showConfirmButton: false
              });
            } else {
              throw new Error('File sharing not supported');
            }
          } catch (error) {
            console.error('Error sharing:', error);
            
            // If sharing fails, try to download instead
            try {
              window.jsPDF = window.jspdf.jsPDF;
              const doc = generateReportWithFileName(fileName, true);
              
              if (!doc) {
                throw new Error('PDF generation failed');
              }
              
              // Use direct save method which is more reliable
              doc.save(fileName);
              
              Swal.fire({
                icon: 'info',
                title: '×”×•×¨×“×” ×‘××§×•× ×©×œ×™×—×”',
                text: '×”×“×•×— ×”×•×¨×“ ×œ××›×©×™×¨ ×©×œ×š',
                timer: 2000,
                showConfirmButton: false
              });
            } catch (downloadError) {
              console.error('Download also failed:', downloadError);
              Swal.fire({
                icon: 'error',
                title: '×©×’×™××”',
                text: '×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ××ª ×”×“×•×—. ×× × × ×¡×” ×©×•×‘.',
                confirmButtonText: '××™×©×•×¨'
              });
            }
          }
        } else {
          // Desktop - use direct download
          generateReportWithFileName(fileName);
        }
      }
    }

    function generateReportWithFileName(fileName, returnDoc = false) {
      // Ensure jsPDF is available
      if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
        console.error('jsPDF library not loaded');
        Swal.fire({
          icon: 'error',
          title: '×©×’×™××”',
          text: '×¡×¤×¨×™×™×ª PDF ×œ× × ×˜×¢× ×”. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£.',
          confirmButtonText: '××™×©×•×¨'
        });
        return null;
      }
      
      window.jsPDF = window.jspdf.jsPDF;
      const doc = new jsPDF();
      doc.setR2L(false);

      // Header - gradient-like effect with purple/blue
      doc.setFillColor(102, 126, 234);
      doc.rect(0, 0, doc.internal.pageSize.width, 50, 'F');
      
      // Add a subtle gradient effect
      doc.setFillColor(118, 75, 162);
      doc.rect(0, 0, doc.internal.pageSize.width, 15, 'F');
      
      // Title - bold and centered (removed emojis for PDF compatibility)
      doc.setFontSize(20);
      doc.setTextColor(255, 255, 255);
      doc.setFont('helvetica', 'bold');
      doc.text("Math Practice Report", doc.internal.pageSize.width / 2, 28, { align: "center" });
      
      // Content styling
      doc.setTextColor(30, 41, 59);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');

      // Level and date section - styled box
      doc.setFillColor(248, 249, 255);
      doc.roundedRect(20, 60, doc.internal.pageSize.width - 40, 25, 5, 5, 'F');
      doc.setDrawColor(102, 126, 234);
      doc.setLineWidth(1);
      doc.roundedRect(20, 60, doc.internal.pageSize.width - 40, 25, 5, 5);
      
      const now = new Date();
      const dateStr = `${now.getMonth() + 1}/${String(now.getDate()).padStart(2, '0')}/${now.getFullYear()}`;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text(`Major Level: ${majorLevel}`, 30, 72);
      doc.text(`Sub Level: ${subLevel}`, doc.internal.pageSize.width / 2, 72, { align: "center" });
      doc.text(`Date: ${dateStr}`, doc.internal.pageSize.width - 30, 72, { align: "right" });

      // Stats box - colorful and well-designed
      doc.setFillColor(102, 126, 234);
      doc.setDrawColor(102, 126, 234);
      doc.setLineWidth(2);
      doc.roundedRect(20, 95, doc.internal.pageSize.width - 40, 50, 8, 8);

      // Stats background
      doc.setFillColor(248, 249, 255);
      doc.roundedRect(22, 97, doc.internal.pageSize.width - 44, 46, 6, 6, 'F');

      // Calculate stats from actual tracked questions
      const correctQuestions = allQuestions.filter(q => q.status === 'correct');
      const wrongQuestions = allQuestions.filter(q => q.status === 'wrong');
      const skippedQuestions = allQuestions.filter(q => q.status === 'skipped');
      const totalQuestions = allQuestions.length;
      const correctCount = correctQuestions.length;
      const wrongCount = wrongQuestions.length;
      const skippedCount = skippedQuestions.length;
      const accuracy = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(102, 126, 234);
      doc.text(`Score: ${score}`, 30, 110);
      doc.text(`Streak: ${streak}`, doc.internal.pageSize.width / 2, 110, { align: "center" });
      doc.text(`Accuracy: ${accuracy}%`, doc.internal.pageSize.width - 30, 110, { align: "right" });

      doc.setFontSize(12);
      doc.setTextColor(71, 85, 105);
      doc.text(`Total Questions: ${totalQuestions}`, 30, 125);
      doc.text(`Correct: ${correctCount}`, doc.internal.pageSize.width / 2, 125, { align: "center" });
      doc.text(`Wrong: ${wrongCount} | Skipped: ${skippedCount}`, doc.internal.pageSize.width - 30, 125, { align: "right" });
      
      doc.setFontSize(11);
      doc.text(`Current Level: ${majorLevel}.${subLevel}`, 30, 138);

      // Questions table - show ALL questions grouped by status
      let startY = 160;
      
      if (totalQuestions > 0) {
        // Show all questions in one table with status column
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(102, 126, 234);
        doc.text("All Questions:", doc.internal.pageSize.width / 2, startY, { align: "center" });
        startY += 10;

        // Sort questions by timestamp (oldest first)
        const sortedQuestions = [...allQuestions].sort((a, b) => a.timestamp - b.timestamp);
        
        const tableData = sortedQuestions.map((q, index) => {
          let statusText = '';
          let statusColor = [71, 85, 105]; // Default gray
          if (q.status === 'correct') {
            statusText = 'Correct';
            statusColor = [16, 185, 129]; // Green
          } else if (q.status === 'wrong') {
            statusText = 'Wrong';
            statusColor = [239, 68, 68]; // Red
          } else {
            statusText = 'Skipped';
            statusColor = [245, 158, 11]; // Orange
          }
          
          return [
            (index + 1).toString(),
            q.question,
            q.userAnswer.toString() === '×“×™×œ×’/×”' ? 'skipped' : q.userAnswer.toString(),
            q.correctAnswer.toString(),
            statusText
          ];
        });

        doc.autoTable({
          startY: startY,
          margin: { left: 20, right: 20 },
          head: [['#', 'Question', 'Your Answer', 'Correct Answer', 'Status']],
          body: tableData,
          theme: 'striped',
          styles: {
            font: 'helvetica',
            fontSize: 9,
            cellPadding: 4,
            lineColor: [102, 126, 234],
            lineWidth: 0.5,
            halign: 'left',
            textColor: [30, 41, 59],
            overflow: 'linebreak',
            cellWidth: 'wrap'
          },
          headStyles: {
            fillColor: [102, 126, 234],
            textColor: [255, 255, 255],
            fontSize: 10,
            fontStyle: 'bold',
            halign: 'center'
          },
          alternateRowStyles: {
            fillColor: [248, 249, 255]
          },
          columnStyles: {
            0: { cellWidth: 15, halign: 'center' }, // #
            1: { cellWidth: 'auto', minCellWidth: 60, halign: 'left' }, // Question
            2: { cellWidth: 40, halign: 'center' }, // Your Answer
            3: { cellWidth: 40, halign: 'center' }, // Correct Answer
            4: { cellWidth: 35, halign: 'center', fontStyle: 'bold' } // Status
          },
          tableWidth: doc.internal.pageSize.width - 40,
          showHead: 'everyPage',
          showFoot: false,
          pageBreak: 'auto',
          rowPageBreak: 'avoid',
          didParseCell: function (hookData) {
            // Ensure text wraps properly
            hookData.cell.styles.overflow = 'linebreak';
            hookData.cell.styles.cellWidth = 'wrap';
            
            // Color-code status column
            if (hookData.column.index === 4) { // Status column
              const statusText = hookData.cell.text[0];
              if (statusText && statusText.includes('Correct')) {
                hookData.cell.styles.textColor = [16, 185, 129];
              } else if (statusText && statusText.includes('Wrong')) {
                hookData.cell.styles.textColor = [239, 68, 68];
              } else if (statusText && statusText.includes('Skipped')) {
                hookData.cell.styles.textColor = [245, 158, 11];
              }
            }
          }
        });
      }

      // Enhanced footer
      const timestamp = new Date().toLocaleString('en-US', { 
        month: 'numeric',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true 
      }).replace(',', '');
      
      // Footer background
      const footerY = doc.internal.pageSize.height - 20;
      doc.setFillColor(248, 249, 255);
      doc.rect(0, footerY, doc.internal.pageSize.width, 20, 'F');
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(102, 126, 234);
      doc.text(`Math Practice App`, doc.internal.pageSize.width / 2, footerY + 10, { align: "center" });
      
      doc.setFontSize(8);
      doc.setTextColor(148, 163, 184);
      doc.text(`Generated on ${timestamp}`, doc.internal.pageSize.width / 2, footerY + 14, { align: "center" });
      
      // Add creator credit - centered
      doc.setFontSize(7);
      doc.setTextColor(102, 126, 234);
      doc.setFont('helvetica', 'normal');
      doc.text(`Created by Itamar Valdman`, doc.internal.pageSize.width / 2, footerY + 17, { align: "center" });

      // Ensure PDF is finalized before returning/saving
      // This ensures all content is properly rendered
      try {
        if (returnDoc) {
          // Force finalization by accessing internal properties
          // This ensures the PDF is complete before returning
          const testOutput = doc.output('arraybuffer');
          if (!testOutput || testOutput.byteLength === 0) {
            throw new Error('PDF generation produced empty output');
          }
          return doc;
        } else {
          doc.save(fileName);
        }
      } catch (error) {
        console.error('Error finalizing PDF:', error);
        if (returnDoc) {
          // Return doc anyway, but log the error
          return doc;
        } else {
          // Try to save anyway
          try {
            doc.save(fileName);
          } catch (saveError) {
            console.error('Error saving PDF:', saveError);
            Swal.fire({
              icon: 'error',
              title: '×©×’×™××”',
              text: '×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ××ª ×”×“×•×—. ×× × × ×¡×” ×©×•×‘.',
              confirmButtonText: '××™×©×•×¨'
            });
          }
        }
      }
    }

    function sendEmailReport() {
      shareReport();
    }

    function showInfo() {
      Swal.fire({
        title: '××™×“×¢ ×¢×œ ×”×ª×•×›× ×™×ª',
        html: `
          <div style="text-align: right; direction: rtl; font-size: 16px; line-height: 1.8;">
            <p style="margin-bottom: 25px; color: #1e293b;">
              <strong>×ª×•×›× ×™×ª ×ª×¨×’×•×œ ××ª××˜×™×§×”</strong>
            </p>
            <p style="margin-bottom: 20px; color: #475569; font-size: 15px;">
              ×”×ª×•×›× ×™×ª × ×•×¦×¨×” ×¢×œ ×™×“×™ <strong>××™×ª××¨ ×•×œ×“××Ÿ</strong> ×•×”×™× ×—×™× ××™×ª ×œ×©×™××•×©.
            </p>
            <p style="margin-bottom: 15px; color: #64748b; font-size: 13px;">
              Â© ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª
            </p>
            <div style="margin-bottom: 0; text-align: center;">
              <a href="https://buymeacoffee.com/ItamarValdman" 
                 target="_blank" 
                 rel="noopener noreferrer"
                 style="display: inline-block; 
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
                        color: white; 
                        padding: 8px 16px; 
                        border-radius: 8px; 
                        text-decoration: none; 
                        font-weight: 600; 
                        font-size: 14px;
                        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
                        transition: all 0.3s ease;
                        margin: 0 auto;">
                â˜• ×ª××•×š ×‘×¤×™×ª×•×—
              </a>
            </div>
          </div>
        `,
        width: '500px',
        padding: '30px',
        background: '#ffffff',
        showCloseButton: true,
        showConfirmButton: true,
        confirmButtonText: '×¡×’×•×¨',
        confirmButtonColor: '#667eea',
        customClass: {
          popup: 'rtl-popup',
          title: 'info-title',
          htmlContainer: 'info-content'
        },
        didOpen: () => {
          // Add hover effect to the link
          const link = document.querySelector('a[href*="buymeacoffee"]');
          if (link) {
            link.addEventListener('mouseenter', function() {
              this.style.transform = 'translateY(-2px)';
              this.style.boxShadow = '0 4px 12px rgba(245, 158, 11, 0.6)';
            });
            link.addEventListener('mouseleave', function() {
              this.style.transform = 'translateY(0)';
              this.style.boxShadow = '0 2px 8px rgba(245, 158, 11, 0.4)';
            });
          }
        }
      });
    }

    // Update button label for skip
    document.addEventListener('DOMContentLoaded', function() {
      const skipBtn = Array.from(document.querySelectorAll('.button-group button')).find(btn => btn.textContent.includes('×©××œ×” ×—×“×©×”'));
      if (skipBtn) skipBtn.textContent = '×©××œ×” ×—×“×©×” (5-)';
    });

    // Initialize major level buttons on page load
    if (document.getElementById('gradeSelection')) {
      initializeMajorLevelButtons();
    }
    
    // Detect keyboard visibility on mobile to adjust layout
    if (isMobile) {
      let keyboardVisible = false;
      
      // Detect keyboard visibility by checking viewport height changes
      const checkKeyboard = () => {
        const currentHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
        const screenHeight = window.screen.height;
        const threshold = screenHeight * 0.75; // If viewport is less than 75% of screen, keyboard is likely visible
        
        if (currentHeight < threshold && !keyboardVisible) {
          keyboardVisible = true;
          document.getElementById('gameScreen').classList.add('keyboard-visible');
        } else if (currentHeight >= threshold && keyboardVisible) {
          keyboardVisible = false;
          document.getElementById('gameScreen').classList.remove('keyboard-visible');
        }
      };
      
      // Check on resize and visual viewport changes
      window.addEventListener('resize', checkKeyboard);
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', checkKeyboard);
      }
      
      // Also check when inputs are focused/blurred
      const inputs = [answerInput, fractionWholeInput, fractionNumeratorInput, fractionDenominatorInput];
      inputs.forEach(input => {
        if (input) {
          input.addEventListener('focus', () => {
            setTimeout(checkKeyboard, 300); // Delay to allow keyboard to appear
          });
          input.addEventListener('blur', () => {
            setTimeout(checkKeyboard, 300); // Delay to allow keyboard to disappear
          });
        }
      });
    }
    
    // State is loaded in loadState() function which is called earlier
    // If no saved state, show level selection
    if (!localStorage.getItem('currentScreen')) {
      document.getElementById('gradeSelection').style.display = 'flex';
      document.getElementById('gameScreen').classList.remove('active');
      updateStats();
    }
  </script>
</body>
</html>

